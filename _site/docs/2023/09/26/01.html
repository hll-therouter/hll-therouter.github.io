<!doctype html>
<html lang="en">

  <head>
  <!-- meta data & title -->
  <meta charset="utf-8">
  <title>TheRouterSwift iOS 路由介绍</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="TheRouter 是一个 Kotlin 编写，用于 Android 模块化开发的一整套解决方案框架。">
  <meta name="author" content="TheRouter">
  <meta name="keyword"
      content="TheRouterSwift iOS 路由介绍,android,kotlin,arouter,TheRouter">

  <meta name="keywords"
      content="TheRouterSwift iOS 路由介绍,android,kotlin,arouter,therouter,studio,优质开发技术">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous"> 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.kymjs.com:8843/therouter_assets/css/animate.min.css">
  <link rel="stylesheet" href="https://cdn.kymjs.com:8843/therouter_assets/css/style2.css">
  <link rel="stylesheet" href="https://cdn.kymjs.com:8843/therouter_assets/css/kymjs1.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.kymjs.com:8843/therouter_assets/css/prism.css">

  <script type="text/javascript" src="https://cdn.kymjs.com:8843/therouter_assets/js/prism.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
</head>
  <script type="text/javascript" src="https://cdn.kymjs.com:8843/therouter_assets/js/jquery-1.10.2.min.js"></script>
<script src="https://cdn.kymjs.com:8843/therouter_assets/js/wow.min.js"></script>
<script>
  new WOW().init();
</script>
  
  <body>
    <div class="container">
  <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
    <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
      <img src="https://cdn.kymjs.com:8843/therouter_assets/img/logo/logo4.png" width="170px">
    </a>

    <ul class="nav nav-pills">
      
      <li class="nav-item">
        
          <a href="/" class="nav-link header-color" aria-current="page">首页</a>
         
      </li>
      <li class="nav-item">
        
          <a href="/doc" class="nav-link header-color">Android</a>
         
      </li>
      <li class="nav-item">
        
          <a href="/harmony" class="nav-link header-color">Harmony</a>
         
      </li>
      <li class="nav-item">
        
          <a href="/ios" class="nav-link active header-color">iOS</a>
         
      </li>
      <li class="nav-item">
        
          <a href="/ai" class="nav-link header-color">求助</a>
         
      </li>
      <li class="nav-item">
        
          <a href="/docs/2022/08/24/01" class="nav-link header-color">关于</a>
         
      </li>
    </ul>
  </header>
</div>


<!-- End Header -->
  	
  		<h2 class="blog-title" align="center">TheRouterSwift iOS 路由介绍</h2>
      <br>
  	
    <!-- Main Container -->
<div class="container">
	<div class="blog-post">
		<h2 id="背景">背景</h2>
<ol>
  <li>随着社区对支持Swift的需求日益增多，Swift5.0二进制库也具有更好的稳定性和兼容性表现，货拉拉技术团队根据社区反馈及内部讨论，决定开源内部业务使用的Swift版本路由组件，与2023年8月份已发布的Objective-C版本路由组件组成一个完整解决方案。</li>
  <li>TheRouter开源团队将把重心放在维护和升级Swift版本的TheRouter上。同时也会持续支持Objective-C版本的易用性，并欢迎社区贡献。</li>
  <li>对于使用Objective-C版本TheRouter的用户，建议将版本固定为1.0.0版以确保稳定性。
    <h2 id="features">Features</h2>
    <p>TheRouter一个用于模块间解耦和通信，基于Swift协议进行动态懒加载注册路由与打开路由的工具。同时支持通过Service-Protocol寻找对应的模块，并用 protocol进行依赖注入和模块通信。</p>
    <ul>
      <li><strong>1. 页面导航跳转能力</strong>：支持常规vc或Storyboard的push/present/popToTaget/windowNavRoot/modalDismissBeforePush跳转能力；</li>
      <li><strong>2. 路由自动注册能力</strong>：懒加载方式动态注册路由，仅当第一次调用OpenURL时进行动态注册；</li>
      <li><strong>3. 路由映射文件导出</strong>：支持将工程中的路由映射关系导出为文档，支持JSON、Plist格式，方便开发者进行双端的汇总比对、记录等；</li>
      <li><strong>4. 服务自动注册能力</strong>：动态注册服务，使用runtime方式自动注入；</li>
      <li><strong>5. 硬编码消除</strong>：将注册的path转为静态字符串常量供业务使用；</li>
      <li><strong>6. 动态化能力</strong>：支持添加重定向，移除重定向、动态添加路由、动态移除路由、拦截器、错误path修复等；</li>
      <li><strong>7. 链式编程</strong>：支持链式编程方式拼接URL与参数；</li>
      <li><strong>8. 适配Objective-C</strong>：OC类可以在Swift中使用继承的方式遵循协议来进行动态注册；</li>
      <li><strong>9. 服务调用</strong>：支持本地服务调用与远端服务调用；</li>
    </ul>
  </li>
</ol>

<p><img src="https://z1.ax1x.com/2023/09/26/pPHS4UO.png" class="blog-img" /></p>

<h1 id="背景-1">背景</h1>
<p>随着项目需求的日益增加，开发人员的不断增加，带来了很多问题：</p>

<ul>
  <li>
    <p>模块划分不清晰，任何开发人员随意调用并修改其他模块的代码实现以满足自己的业务需求。</p>
  </li>
  <li>
    <p>维护困难，同一组件的不同服务，散落在工程各个地方，不利于统一维护修改替换。</p>
  </li>
  <li>
    <p>模块负责人无法清晰，导致同一功能多人维护，造成冲突。</p>
  </li>
</ul>

<p>另外件拆分完之后都上升到远端，那么它们之间本地的代码是没办法相互依赖的，所以就需要通过一种工具，然后去实现透传服务的能力。我们需要一个中间件去处理这些问题。路由即是将耦合进行转移，通过增加中间层映射关系，解决业务之间的依赖关系。</p>

<h2 id="一个成熟的路由该是什么样子">一个成熟的路由该是什么样子</h2>

<p><strong>1.</strong>  业务组件化之后，组件化需要将整个项目的各个模块进行解耦，升级远端之后，界面之间的跳转怎么解决？<strong>路由 Api</strong></p>

<p><strong>2.</strong>  动态注册路由，无需手动注册。服务的动态注册，无需手动注册。</p>

<p><strong>3.</strong>  端上跳转统一问题怎么解决？<strong>使用统一 URL 映射方式处理</strong></p>

<p><strong>4.</strong>  业务跳转中出现问题，如何修改跳转逻辑？服务如何降级? <strong>远端下发配置，修改跳转 URL</strong></p>

<p><strong>5.</strong>  业务服务异常，界面改为 h5 界面。<strong>重定向</strong></p>

<p><strong>6.</strong>  App 跳转出现问题如何跳转到同一个本地的 error 界面？<strong>统一失败处理</strong></p>

<p><strong>7.</strong>  如何在跳转前增加强制的业务逻辑处理，比如业务调整，必须先执行某些操作，才能进入。<strong>重定向</strong></p>

<p><strong>8.</strong>  业务中有很多需要前置跳转，比如先登录才能去订单列表，如何实现。<strong>拦截器</strong></p>

<p><strong>9.</strong>  如何测试各个跳转业务是否正常。 <strong>路由 Path 校验</strong></p>

<p><strong>10.</strong> 如何把最频繁的业务跳转前置，减少查询次数？<strong>增加优先级 priority</strong></p>

<p><strong>11.</strong> 本地服务通过路由调用，远端服务通过路由调用 <strong>支持服务调用</strong></p>

<h2 id="整体设计思路">整体设计思路</h2>

<p>为了和Android端保持一致，使用了URL，class注册的方式实现。通过URL匹配方式查询数组中保存的模版信息，找到执行获取对应实例，执行跳转操作。</p>

<p><img src="https://z1.ax1x.com/2023/09/26/pP7zc0f.png" class="blog-img" /></p>

<h2 id="使用介绍预览">使用介绍预览</h2>

<p><img src="https://cdn.kymjs.com:8843/therouter_assets/img/image/therouter_ios1.gif" class="blog-img" /></p>

<h2 id="如何集成使用">如何集成使用</h2>

<h3 id="cocoapods">CocoaPods</h3>

<p>Add the following entry in your Podfile:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">pod</span> <span class="err">'</span><span class="nc">TheRouter</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="mf">1.1.0</span><span class="err">'</span>
</code></pre></div></div>

<h2 id="swift限制版本">Swift限制版本</h2>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nc">Swift5</span><span class="mf">.0</span> <span class="n">or</span> <span class="n">above</span>
</code></pre></div></div>

<h2 id="therouter-使用方式">TheRouter 使用方式</h2>

<ol>
  <li>
    <h3 id="注册">注册</h3>
  </li>
</ol>

<p>鉴于已经实现了自动注册能力，开发者无需自己添加路由，只需要进行如下操作即可</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// 实现TheRouterable协议</span>
<span class="n">extension</span> <span class="nc">TheRouterController</span><span class="p">:</span> <span class="nc">TheRouterable</span> <span class="p">{</span>
    
    <span class="n">static</span> <span class="kd">var</span> <span class="py">patternString</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">]</span> <span class="p">{</span>
<span class="na">        ["scheme://router/demo"]</span>
    <span class="p">}</span>
    
    <span class="n">static</span> <span class="n">func</span> <span class="nf">registerAction</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span> <span class="p">:</span> <span class="nc">Any</span><span class="p">])</span> <span class="p">-&gt;</span> <span class="nc">Any</span> <span class="p">{</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        
        <span class="n">let</span> <span class="n">vc</span> <span class="p">=</span>  <span class="nc">TheRouterController</span><span class="p">()</span>
        <span class="n">vc</span><span class="p">.</span><span class="n">qrResultCallBack</span> <span class="p">=</span> <span class="n">info</span><span class="p">[</span><span class="s">"clouse"</span><span class="p">]</span> <span class="k">as</span><span class="p">?</span> <span class="nc">QrScanResultCallBack</span>
        <span class="n">vc</span><span class="p">.</span><span class="n">resultLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">description</span>
        <span class="k">return</span> <span class="n">vc</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// 在AppDelegate中实现懒加载的闭包</span>
<span class="c1">// 路由懒加载注册</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">lazyRegisterRouterHandle</span> <span class="p">{</span> <span class="n">url</span><span class="p">,</span> <span class="n">userInfo</span> <span class="k">in</span>
    <span class="nc">TheRouterManager</span><span class="p">.</span><span class="nf">injectRouterServiceConfig</span><span class="p">(</span><span class="n">webRouterUrl</span><span class="p">,</span> <span class="n">serivceHost</span><span class="p">)</span>
    <span class="k">return</span> <span class="nc">TheRouterManager</span><span class="p">.</span><span class="nf">addGloableRouter</span><span class="p">([</span><span class="s">".The"</span><span class="p">],</span> <span class="n">url</span><span class="p">,</span> <span class="n">userInfo</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 动态注册服务</span>
<span class="nc">TheRouterManager</span><span class="p">.</span><span class="nf">registerServices</span><span class="p">()</span>

<span class="c1">// 日志回调，可以监控线上路由运行情况</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">logcat</span> <span class="p">{</span> <span class="n">url</span><span class="p">,</span> <span class="n">logType</span><span class="p">,</span> <span class="n">errorMsg</span> <span class="k">in</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"TheRouter: logMsg- \(url) \(logType.rawValue) \(errorMsg)"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="oc-注解的形式">OC 注解的形式</h4>

<p>这里列举了OC使用注解的方式，Swift因为其缺乏动态性，是不支持注解的。</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//使用注解</span>
<span class="err">@</span><span class="nf">page</span><span class="p">(</span><span class="s">@"home/main"</span><span class="p">)</span>
<span class="p">-</span> <span class="p">(</span><span class="nc">UIViewController</span> <span class="p">*)</span><span class="nf">homePage</span><span class="p">{</span>
    <span class="c1">// Do stuff...</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="swift-注册形式">Swift 注册形式</h4>

<p>Swift 中，我们都知道 Swift 是不支持注解的，那么 Swift 动态注册路由该怎么解决呢，我们使用 runtime 遍历工程里的方式找到遵循了路由协议的类进行自动注册。</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kd">class</span> <span class="err">func register</span><span class="nc">RouterMap</span><span class="p">(</span><span class="n">_</span> <span class="n">registerClassPrifxArray</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">],</span> <span class="n">_</span> <span class="n">urlPath</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">_</span> <span class="n">userInfo</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">])</span> <span class="p">-&gt;</span> <span class="nc">Any</span><span class="p">?</span> <span class="p">{</span>
        
        <span class="n">let</span> <span class="n">expectedClassCount</span> <span class="p">=</span> <span class="nf">objc_getClassList</span><span class="p">(</span><span class="n">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">allClasses</span> <span class="p">=</span> <span class="nc">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="nc">AnyClass</span><span class="p">&gt;.</span><span class="nf">allocate</span><span class="p">(</span><span class="n">capacity</span><span class="p">:</span> <span class="nc">Int</span><span class="p">(</span><span class="n">expectedClassCount</span><span class="p">))</span>
        <span class="n">let</span> <span class="n">autoreleasingAllClasses</span> <span class="p">=</span> <span class="nc">AutoreleasingUnsafeMutablePointer</span><span class="p">&lt;</span><span class="nc">AnyClass</span><span class="p">&gt;(</span><span class="n">allClasses</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">actualClassCount</span><span class="p">:</span> <span class="nc">Int32</span> <span class="p">=</span> <span class="nf">objc_getClassList</span><span class="p">(</span><span class="n">autoreleasingAllClasses</span><span class="p">,</span> <span class="n">expectedClassCount</span><span class="p">)</span>
        
        <span class="kd">var</span> <span class="py">resultXLClass</span> <span class="p">=</span> <span class="p">[</span><span class="nc">AnyClass</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span> <span class="o">..</span><span class="p">&lt;</span> <span class="nf">actualClassCount</span> <span class="p">{</span>
            
            <span class="n">let</span> <span class="n">currentClass</span><span class="p">:</span> <span class="nc">AnyClass</span> <span class="p">=</span> <span class="n">allClasses</span><span class="p">[</span><span class="nc">Int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
            <span class="n">let</span> <span class="n">fullClassName</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="nc">NSStringFromClass</span><span class="p">(</span><span class="n">currentClass</span><span class="p">.</span><span class="n">self</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">value</span> <span class="k">in</span> <span class="nf">registerClassPrifxArray</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fullClassName</span><span class="p">.</span><span class="nf">containsSubString</span><span class="p">(</span><span class="n">substring</span><span class="p">:</span> <span class="n">value</span><span class="p">))</span>  <span class="p">{</span>
                    <span class="k">if</span> <span class="n">currentClass</span> <span class="k">is</span> <span class="nc">UIViewController</span><span class="p">.</span><span class="nc">Type</span> <span class="p">{</span>
                        <span class="n">resultXLClass</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">currentClass</span><span class="p">)</span>
                    <span class="p">}</span>
                    
    <span class="err">#</span><span class="k">if</span> <span class="nc">DEBUG</span>
                    <span class="k">if</span> <span class="n">let</span> <span class="n">clss</span> <span class="p">=</span> <span class="n">currentClass</span> <span class="k">as</span><span class="p">?</span> <span class="nc">CustomRouterInfo</span><span class="p">.</span><span class="nc">Type</span> <span class="p">{</span>
                        <span class="nf">assert</span><span class="p">(</span><span class="n">clss</span><span class="p">.</span><span class="n">patternString</span><span class="p">.</span><span class="nf">hasPrefix</span><span class="p">(</span><span class="s">"scheme://"</span><span class="p">),</span> <span class="s">"URL非scheme://开头，请重新确认"</span><span class="p">)</span>
                        <span class="n">apiArray</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">clss</span><span class="p">.</span><span class="n">patternString</span><span class="p">)</span>
                        <span class="n">classMapArray</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">clss</span><span class="p">.</span><span class="n">routerClass</span><span class="p">)</span>
                    <span class="p">}</span>
    <span class="err">#</span><span class="n">endif</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span> <span class="o">..</span><span class="p">&lt;</span> <span class="n">resultXLClass</span><span class="p">.</span><span class="nf">count</span> <span class="p">{</span>
            <span class="n">let</span> <span class="n">currentClass</span><span class="p">:</span> <span class="nc">AnyClass</span> <span class="p">=</span> <span class="n">resultXLClass</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">let</span> <span class="n">cls</span> <span class="p">=</span> <span class="n">currentClass</span> <span class="k">as</span><span class="p">?</span> <span class="nc">TheRouterable</span><span class="p">.</span><span class="nc">Type</span> <span class="p">{</span>
                <span class="n">let</span> <span class="n">fullName</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="nc">NSStringFromClass</span><span class="p">(</span><span class="n">currentClass</span><span class="p">.</span><span class="n">self</span><span class="p">)</span>
               
                <span class="k">for</span> <span class="n">s</span> <span class="k">in</span> <span class="mi">0</span> <span class="o">..</span><span class="p">&lt;</span> <span class="n">cls</span><span class="p">.</span><span class="n">patternString</span><span class="p">.</span><span class="nf">count</span> <span class="p">{</span>
                    
                    <span class="k">if</span> <span class="n">fullName</span><span class="p">.</span><span class="nf">hasPrefix</span><span class="p">(</span><span class="nc">NSKVONotifyingPrefix</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">let</span> <span class="n">range</span> <span class="p">=</span> <span class="n">fullName</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">fullName</span><span class="p">.</span><span class="n">startIndex</span><span class="p">,</span> <span class="n">offsetBy</span><span class="p">:</span> <span class="nc">NSKVONotifyingPrefix</span><span class="p">.</span><span class="n">count</span><span class="p">)</span><span class="o">..</span><span class="p">&lt;</span><span class="n">fullName</span><span class="p">.</span><span class="n">endIndex</span>
                        <span class="n">let</span> <span class="n">subString</span> <span class="p">=</span> <span class="n">fullName</span><span class="p">[</span><span class="n">range</span><span class="p">]</span>
                        <span class="n">pagePathMap</span><span class="p">[</span><span class="n">cls</span><span class="p">.</span><span class="n">patternString</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="p">=</span> <span class="s">"\(subString)"</span>
                        <span class="nc">TheRouter</span><span class="p">.</span><span class="nf">addRouterItem</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">patternString</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">classString</span><span class="p">:</span> <span class="s">"\(subString)"</span><span class="p">)</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">pagePathMap</span><span class="p">[</span><span class="n">cls</span><span class="p">.</span><span class="n">patternString</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="p">=</span> <span class="n">fullName</span>
                        <span class="nc">TheRouter</span><span class="p">.</span><span class="nf">addRouterItem</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">patternString</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">classString</span><span class="p">:</span> <span class="n">fullName</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
<span class="err">#</span><span class="k">if</span> <span class="nc">DEBUG</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="n">pagePathMap</span><span class="p">)</span>
        <span class="nf">routerForceRecheck</span><span class="p">()</span>
<span class="err">#</span><span class="n">endif</span>
        <span class="nc">TheRouter</span><span class="p">.</span><span class="nf">routerLoadStatus</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">(</span><span class="n">urlPath</span><span class="p">,</span> <span class="n">userInfo</span><span class="p">:</span> <span class="n">userInfo</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>为了避免无效遍历，我们通过传入 registerClassPrifxArray 指定我们遍历包含这些前缀的类即可。一旦是 UIViewController.Type 类型就进行存储，然后再进行校验是否遵循 TheRouterable 协议，遵循则自动注册。无需手动注册。</p>

<h4 id="路由注册的懒加载">路由注册的懒加载</h4>

<p>采用动态注册有一个不好的情况就是在启动时就去动态注册，在 TheRouter 中注册的时机被延后了，放在了 App 第一次通过 TheRouter.openUrl()时进行注册，会判断路由是否加载完毕，未加载完毕进行加载，然后打开路由。</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@</span><span class="n">discardableResult</span>
<span class="k">public</span> <span class="kd">class</span> <span class="err">func open</span><span class="nc">URL</span><span class="p">(</span><span class="n">_</span> <span class="n">urlString</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">userInfo</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">]</span> <span class="p">=</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">](),</span> <span class="n">handler</span><span class="p">:</span> <span class="n">complateHandler</span> <span class="p">=</span> <span class="n">nil</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Any</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">urlString</span><span class="p">.</span><span class="nf">isEmpty</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">nil</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">!</span><span class="n">shareInstance</span><span class="p">.</span><span class="nf">isLoaded</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">shareInstance</span><span class="p">.</span><span class="n">lazyRegisterHandleBlock</span><span class="p">?(</span><span class="n">urlString</span><span class="p">,</span> <span class="n">userInfo</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="k">return</span> <span class="nf">openCacheRouter</span><span class="p">((</span><span class="n">urlString</span><span class="p">,</span> <span class="n">userInfo</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MARK: - Public method</span>
<span class="err">@</span><span class="n">discardableResult</span>
<span class="k">public</span> <span class="kd">class</span> <span class="err">func open</span><span class="nc">URL</span><span class="p">(</span><span class="n">_</span> <span class="n">uriTuple</span><span class="p">:</span> <span class="p">(</span><span class="nc">String</span><span class="p">,</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">]),</span> <span class="n">handler</span><span class="p">:</span> <span class="n">complateHandler</span> <span class="p">=</span> <span class="n">nil</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Any</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">!</span><span class="n">shareInstance</span><span class="p">.</span><span class="nf">isLoaded</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">shareInstance</span><span class="p">.</span><span class="n">lazyRegisterHandleBlock</span><span class="p">?(</span><span class="n">uriTuple</span><span class="mf">.0</span><span class="p">,</span> <span class="n">uriTuple</span><span class="mf">.1</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">openCacheRouter</span><span class="p">(</span><span class="n">uriTuple</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="kd">class</span> <span class="err">func open</span><span class="nc">CacheRouter</span><span class="p">(</span><span class="n">_</span> <span class="n">uriTuple</span><span class="p">:</span> <span class="p">(</span><span class="nc">String</span><span class="p">,</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">]),</span> <span class="n">handler</span><span class="p">:</span> <span class="n">complateHandler</span> <span class="p">=</span> <span class="n">nil</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Any</span><span class="p">?</span> <span class="p">{</span>

    <span class="k">if</span> <span class="n">uriTuple</span><span class="mf">.0</span><span class="p">.</span><span class="nf">isEmpty</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">nil</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">uriTuple</span><span class="mf">.0</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">shareInstance</span><span class="p">.</span><span class="n">serviceHost</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">routerService</span><span class="p">(</span><span class="n">uriTuple</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">routerJump</span><span class="p">(</span><span class="n">uriTuple</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="如何让-oc-类也享受到-swift-路由">如何让 OC 类也享受到 Swift 路由</h4>

<p>这是一个 OC 类的界面，实现路由的跳转需要继承 OC 类，并实现 TheRouterAble 协议即可</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@</span><span class="kd">interface</span> <span class="nc">TheRouterBController</span> <span class="p">:</span> <span class="nc">UIViewController</span>
<span class="err">@</span><span class="nf">property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="nc">UILabel</span> <span class="p">*</span><span class="n">desLabel</span><span class="p">;</span>
<span class="err">@</span><span class="n">end</span>

<span class="err">@</span><span class="kd">interface</span> <span class="nc">TheRouterBController</span> <span class="p">()</span>

<span class="err">@</span><span class="n">end</span>

<span class="err">@</span><span class="n">implementation</span> <span class="nc">TheRouterBController</span>

<span class="p">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
<span class="na">    [super viewDidLoad]</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="p">=</span> <span class="p">[</span><span class="nc">UIColor</span> <span class="n">yellowColor</span><span class="p">];</span>
<span class="na">    [self.view addSubview:self.desLabel]</span><span class="p">;</span>
    <span class="c1">// Do any additional setup after loading the view.</span>
<span class="p">}</span>
<span class="err">@</span><span class="n">end</span>

<span class="k">public</span> <span class="kd">class</span> <span class="nc">TheRouterControllerB</span><span class="p">:</span> <span class="nc">TheRouterBController</span><span class="p">,</span> <span class="nc">TheRouterable</span> <span class="p">{</span>

    <span class="k">public</span> <span class="n">static</span> <span class="kd">var</span> <span class="py">patternString</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">]</span> <span class="p">{</span>
        <span class="p">[</span><span class="s">"scheme://router/demo2"</span><span class="p">,</span>
         <span class="s">"scheme://router/demo2-Android"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="n">static</span> <span class="kd">var</span> <span class="py">descriptions</span><span class="p">:</span> <span class="nc">String</span> <span class="p">{</span>
        <span class="s">"TheRouterControllerDemo"</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">static</span> <span class="n">func</span> <span class="nf">registerAction</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span> <span class="p">:</span> <span class="nc">Any</span><span class="p">])</span> <span class="p">-&gt;</span> <span class="nc">Any</span> <span class="p">{</span>
        <span class="n">let</span> <span class="n">vc</span> <span class="p">=</span>  <span class="nc">TheRouterBController</span><span class="p">()</span>
        <span class="n">vc</span><span class="p">.</span><span class="n">desLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">description</span>
        <span class="k">return</span> <span class="n">vc</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="同时支持手动单个注册">同时支持手动单个注册</h4>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 模型模式</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">addRouterItem</span><span class="p">(</span><span class="nc">RouteItem</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="s">"scheme://router/demo?&amp;desc=简单注册,直接调用TheRouter.addRouterItem()注册即可"</span><span class="p">,</span> <span class="n">className</span><span class="p">:</span> <span class="s">"TheRouter_Example.TheRouterController"</span><span class="p">,</span> <span class="n">desc</span><span class="p">:</span> <span class="s">"简单注册,直接调用TheRouter"</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="p">[</span><span class="s">"key1"</span><span class="p">:</span> <span class="mi">1</span><span class="p">]))</span>
<span class="c1">// 字典模式</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">addRouterItem</span><span class="p">([</span><span class="s">"scheme://router/demo?&amp;desc=简单注册,直接调用TheRouter.addRouterItem()注册即可"</span><span class="p">:</span> <span class="s">"TheRouter_Example.TheRouterController"</span><span class="p">])</span>
<span class="c1">// 常量参数模式</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">addRouterItem</span><span class="p">(</span><span class="s">"scheme://router/demo?&amp;desc=简单注册"</span><span class="p">,</span> <span class="n">classString</span><span class="p">:</span> <span class="s">"TheRouter_Example.TheRouterController"</span><span class="p">)</span>
<span class="c1">// 协议模式， TheRouterApi实现了 CustomRouterInfo协议</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">addRouterItem</span><span class="p">(</span><span class="nc">TheRouterApi</span><span class="p">.</span><span class="n">patternString</span><span class="p">,</span> <span class="n">classString</span><span class="p">:</span> <span class="nc">TheRouterApi</span><span class="p">.</span><span class="n">routerClass</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="同时支持手动批量注册">同时支持手动批量注册</h4>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TheRouter</span><span class="p">.</span><span class="nf">addRouterItem</span><span class="p">([</span><span class="s">"scheme://router/demo"</span><span class="p">:</span> <span class="s">"TheRouter_Example.TheRouterController"</span><span class="p">,</span>
                    <span class="s">"scheme://router/demo1"</span><span class="p">:</span> <span class="s">"TheRouter_Example.TheRouterControllerA"</span><span class="p">])</span>
</code></pre></div></div>

<h3 id="移除">移除</h3>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TheRouter</span><span class="p">.</span><span class="nf">removeRouter</span><span class="p">(</span><span class="nc">TheRouterViewCApi</span><span class="p">.</span><span class="n">patternString</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="打开">打开</h3>

<p>声明了不同的方法，主要用于明显的区分，内部统一调用 openURL</p>

<p>便利构造器链式打开路由</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">let</span> <span class="n">model</span> <span class="p">=</span> <span class="nc">TheRouterModel</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">"AKyS"</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="mi">18</span><span class="p">)</span>
<span class="nc">TheRouterBuilder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="s">"scheme://router/demo"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">withInt</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"intValue"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">withString</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"stringValue"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s">"2222"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">withFloat</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"floatValue"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="mf">3.1415</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">withBool</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"boolValue"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">withDouble</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"doubleValue"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">withAny</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"any"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">model</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">navigation</span><span class="p">()</span>
    
<span class="nc">TheRouterBuilder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="s">"scheme://router/demo"</span><span class="p">)</span>
	<span class="p">.</span><span class="nf">withInt</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"intValue"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">.</span><span class="nf">withString</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"stringValue"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s">"sdsd"</span><span class="p">)</span>
	<span class="p">.</span><span class="nf">withFloat</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"floatValue"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="mf">3.1415</span><span class="p">)</span>
	<span class="p">.</span><span class="nf">withBool</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"boolValue"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
	<span class="p">.</span><span class="nf">withDouble</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"doubleValue"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">)</span>
	<span class="p">.</span><span class="nf">withAny</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">"any"</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">model</span><span class="p">)</span>
	<span class="p">.</span><span class="nf">navigation</span> <span class="p">{</span> <span class="n">params</span><span class="p">,</span> <span class="n">instance</span> <span class="k">in</span>
	    
	<span class="p">}</span>
    
</code></pre></div></div>

<p>打开路由常用方式</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kd">class</span> <span class="nc">TheRouterApi</span><span class="p">:</span> <span class="nc">CustomRouterInfo</span> <span class="p">{</span>

    <span class="k">public</span> <span class="n">static</span> <span class="kd">var</span> <span class="py">patternString</span> <span class="p">=</span> <span class="s">"scheme://router/demo"</span>
    <span class="k">public</span> <span class="n">static</span> <span class="kd">var</span> <span class="py">routerClass</span> <span class="p">=</span> <span class="s">"TheRouter_Example.TheRouterController"</span>
    <span class="k">public</span> <span class="kd">var</span> <span class="py">params</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">]</span> <span class="p">{</span> <span class="k">return</span> <span class="p">[:]</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kd">var</span> <span class="py">jumpType</span><span class="p">:</span> <span class="nc">LAJumpType</span> <span class="p">=</span> <span class="p">.</span><span class="n">push</span>

    <span class="k">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="kd">class</span> <span class="nc">TheRouterAApi</span><span class="p">:</span> <span class="nc">CustomRouterInfo</span> <span class="p">{</span>

    <span class="k">public</span> <span class="n">static</span> <span class="kd">var</span> <span class="py">patternString</span> <span class="p">=</span> <span class="s">"scheme://router/demo1"</span>
    <span class="k">public</span> <span class="n">static</span> <span class="kd">var</span> <span class="py">routerClass</span> <span class="p">=</span> <span class="s">"TheRouter_Example.TheRouterControllerA"</span>
    <span class="k">public</span> <span class="kd">var</span> <span class="py">params</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">]</span> <span class="p">{</span> <span class="k">return</span> <span class="p">[:]</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kd">var</span> <span class="py">jumpType</span><span class="p">:</span> <span class="nc">LAJumpType</span> <span class="p">=</span> <span class="p">.</span><span class="n">push</span>

    <span class="k">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">(</span><span class="nc">TheRouterCApi</span><span class="p">.</span><span class="nf">init</span><span class="p">().</span><span class="n">requiredURL</span><span class="p">)</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openWebURL</span><span class="p">(</span><span class="s">"https://xxxxxxxx"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="err">@</span><span class="n">discardableResult</span>
<span class="k">public</span> <span class="kd">class</span> <span class="err">func open</span><span class="nc">WebURL</span><span class="p">(</span><span class="n">_</span> <span class="n">uriTuple</span><span class="p">:</span> <span class="p">(</span><span class="nc">String</span><span class="p">,</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">]))</span> <span class="p">-&gt;</span> <span class="nc">Any</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">(</span><span class="n">uriTuple</span><span class="p">)</span>
<span class="p">}</span>

<span class="err">@</span><span class="n">discardableResult</span>
<span class="k">public</span> <span class="kd">class</span> <span class="err">func open</span><span class="nc">WebURL</span><span class="p">(</span><span class="n">_</span> <span class="n">urlString</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
                             <span class="n">userInfo</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">]</span> <span class="p">=</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">]())</span> <span class="p">-&gt;</span> <span class="nc">Any</span><span class="p">?</span> <span class="p">{</span>
    <span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">((</span><span class="n">urlString</span><span class="p">,</span> <span class="n">userInfo</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>元祖形式传入路由与追加参数</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">((</span><span class="s">"scheme://router/demo1?id=2&amp;value=3&amp;name=AKyS&amp;desc=直接调用TheRouter.addRouterItem()注册即可，支持单个注册，批量注册，动态注册，懒加载动态注册"</span><span class="p">,</span> <span class="p">[</span><span class="s">"descs"</span><span class="p">:</span> <span class="s">"追加参数"</span><span class="p">]))</span>
</code></pre></div></div>

<p>参数传递方式</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">let</span> <span class="n">clouse</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">qrResult</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">qrStatus</span><span class="p">:</span> <span class="nc">Bool</span><span class="p">)</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"\(qrResult) \(qrStatus)"</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">makeToast</span><span class="p">(</span><span class="s">"\(qrResult) \(qrStatus)"</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">let</span> <span class="n">model</span> <span class="p">=</span> <span class="nc">TheRouterModel</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">"AKyS"</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="mi">18</span><span class="p">)</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">((</span><span class="s">"scheme://router/demo?id=2&amp;value=3&amp;name=AKyS"</span><span class="p">,</span> <span class="p">[</span><span class="s">"model"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">"clouse"</span><span class="p">:</span> <span class="n">clouse</span><span class="p">]))</span>
</code></pre></div></div>

<h3 id="全局失败映射">全局失败映射</h3>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TheRouter</span><span class="p">.</span><span class="nf">globalOpenFailedHandler</span> <span class="p">{</span> <span class="n">info</span> <span class="k">in</span>
   <span class="nf">debugPrint</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="拦截">拦截</h3>

<p>比如在未登录情况下统一拦截：跳转消息列表之前先去登录，登录成功之后跳转到消息列表等。</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">let</span> <span class="n">login</span> <span class="p">=</span> <span class="nc">TheRouterLoginApi</span><span class="p">.</span><span class="n">templateString</span>
 <span class="nc">TheRouter</span><span class="p">.</span><span class="nf">addRouterInterceptor</span><span class="p">([</span><span class="n">login</span><span class="p">],</span> <span class="n">priority</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Bool</span> <span class="k">in</span>
       <span class="k">if</span> <span class="nc">LALoginManger</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="nf">isLogin</span> <span class="p">{</span>
             <span class="k">return</span> <span class="k">true</span>
       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
             <span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">(</span><span class="nc">TheRouterLoginApi</span><span class="p">().</span><span class="n">build</span><span class="p">)</span>
             <span class="k">return</span> <span class="k">false</span>
       <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div></div>

<p>登录成功之后删除拦截器即可。</p>

<h3 id="路由-path-与类正确安全校验">路由 Path 与类正确安全校验</h3>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// MARK: - 客户端强制校验，是否匹配</span>
<span class="k">public</span> <span class="n">static</span> <span class="n">func</span> <span class="nf">routerForceRecheck</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">let</span> <span class="n">patternArray</span> <span class="p">=</span> <span class="nc">Set</span><span class="p">(</span><span class="n">pagePathMap</span><span class="p">.</span><span class="n">keys</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">apiPathArray</span> <span class="p">=</span> <span class="nc">Set</span><span class="p">(</span><span class="n">apiArray</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">diffArray</span> <span class="p">=</span> <span class="n">patternArray</span><span class="p">.</span><span class="nf">symmetricDifference</span><span class="p">(</span><span class="n">apiPathArray</span><span class="p">)</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"URL差集：\(diffArray)"</span><span class="p">)</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"pagePathMap：\(pagePathMap)"</span><span class="p">)</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">diffArray</span><span class="p">.</span><span class="n">count</span> <span class="p">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"URL 拼写错误，请确认差集中的url是否匹配"</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">patternValueArray</span> <span class="p">=</span> <span class="nc">Set</span><span class="p">(</span><span class="n">pagePathMap</span><span class="p">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">classPathArray</span> <span class="p">=</span> <span class="nc">Set</span><span class="p">(</span><span class="n">classMapArray</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">diffClassesArray</span> <span class="p">=</span> <span class="n">patternValueArray</span><span class="p">.</span><span class="nf">symmetricDifference</span><span class="p">(</span><span class="n">classPathArray</span><span class="p">)</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"classes差集：\(diffClassesArray)"</span><span class="p">)</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">diffClassesArray</span><span class="p">.</span><span class="n">count</span> <span class="p">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"classes 拼写错误，请确认差集中的class是否匹配"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="踩坑路由注册-kvo">踩坑路由注册-KVO</h3>

<p>在进行 classes 本地校验时遇到了类名不匹配问题。</p>

<p>排查原因： 是因为为了避免路由在启动时就注册，影响启动速度，采用了懒加载的方式即第一次打开路由界面的时候才先进行注册然后跳转。但是在我们动态注册之前，某个类因为添加了 KVO (Key-Value Observing 键值监听)，这个类在遍历时 className 修改为了 NSKVONotifying_xxx。需要我们进行特殊处理，如下</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// 对于KVO监听，动态创建子类，需要特殊处理</span>
<span class="k">public</span> <span class="n">let</span> <span class="nc">NSKVONotifyingPrefix</span> <span class="p">=</span> <span class="s">"NSKVONotifying_"</span>

<span class="k">if</span> <span class="n">fullName</span><span class="p">.</span><span class="nf">hasPrefix</span><span class="p">(</span><span class="nc">NSKVONotifyingPrefix</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">let</span> <span class="n">range</span> <span class="p">=</span> <span class="n">fullName</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">fullName</span><span class="p">.</span><span class="n">startIndex</span><span class="p">,</span> <span class="n">offsetBy</span><span class="p">:</span> <span class="nc">NSKVONotifyingPrefix</span><span class="p">.</span><span class="n">count</span><span class="p">)</span><span class="o">..</span><span class="p">&lt;</span><span class="n">fullName</span><span class="p">.</span><span class="n">endIndex</span>
    <span class="n">let</span> <span class="n">subString</span> <span class="p">=</span> <span class="n">fullName</span><span class="p">[</span><span class="n">range</span><span class="p">]</span>
    <span class="n">pagePathMap</span><span class="p">[</span><span class="n">cls</span><span class="p">.</span><span class="n">patternString</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="p">=</span> <span class="s">"\(subString)"</span>
    <span class="nc">TheRouter</span><span class="p">.</span><span class="nf">addRouterItem</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">patternString</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">classString</span><span class="p">:</span> <span class="s">"\(subString)"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="动态调用路由">动态调用路由</h2>

<p>在之上的路由能力下，我们希望 App 能够支持动态增加路由，删除路由，重定向路由、通过路由调起本地服务、远端通过路由调起 App 服务能力，随即进行了动态化的扩展。</p>

<h3 id="重定向功能">重定向功能</h3>
<p>定义路由下发模型数据结构</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">struct</span> <span class="nc">TheRouterInfo</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{}</span>
    
    <span class="k">public</span> <span class="kd">var</span> <span class="py">targetPath</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">""</span>
    <span class="k">public</span> <span class="kd">var</span> <span class="py">orginPath</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">""</span>
    <span class="c1">// 1: 表示替换或者修复客户端代码path错误 2: 新增路由path 3:删除路由</span>
    <span class="k">public</span> <span class="kd">var</span> <span class="py">routerType</span><span class="p">:</span> <span class="nc">TheRouterReloadMapEnum</span> <span class="p">=</span> <span class="p">.</span><span class="n">none</span> 
    <span class="k">public</span> <span class="kd">var</span> <span class="py">path</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">""</span> <span class="c1">// 新的路由地址</span>
    <span class="k">public</span> <span class="kd">var</span> <span class="py">className</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">""</span> <span class="c1">// 路由地址对应的界面</span>
    <span class="k">public</span> <span class="kd">var</span> <span class="py">params</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">]</span> <span class="p">=</span> <span class="p">[:]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>通过远端下发重定向数据，原本跳转到白色界面的业务逻辑改为跳转到黄色界面</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">let</span> <span class="n">relocationMap</span> <span class="p">=</span> <span class="p">[</span><span class="s">"routerType"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"targetPath"</span><span class="p">:</span> <span class="s">"scheme://router/demo1"</span><span class="p">,</span> <span class="s">"orginPath"</span><span class="p">:</span> <span class="s">"scheme://router/demo"</span><span class="p">]</span> <span class="k">as</span> <span class="nc">NSDictionary</span>
<span class="nc">TheRouterManager</span><span class="p">.</span><span class="nf">addRelocationHandle</span><span class="p">(</span><span class="n">routerMapList</span><span class="p">:</span> <span class="p">[</span><span class="n">relocationMap</span><span class="p">])</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">(</span><span class="s">"scheme://router/demo?desc=跳转白色界面被重定向到了黄色界面"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="重定向恢复">重定向恢复</h3>

<p>在业务中，通常会进行业务调整，那么重定向之后需要恢复的话，就需要移除重定向</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">let</span> <span class="n">relocationMap</span> <span class="p">=</span> <span class="p">[</span><span class="s">"routerType"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">"targetPath"</span><span class="p">:</span> <span class="s">"scheme://router/demo"</span><span class="p">,</span> <span class="s">"orginPath"</span><span class="p">:</span> <span class="s">"scheme://router/demo"</span><span class="p">]</span> <span class="k">as</span> <span class="nc">NSDictionary</span>
<span class="nc">TheRouterManager</span><span class="p">.</span><span class="nf">addRelocationHandle</span><span class="p">(</span><span class="n">routerMapList</span><span class="p">:</span> <span class="p">[</span><span class="n">relocationMap</span><span class="p">])</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">(</span><span class="s">"scheme://router/demo?desc=跳转白色界面被重定向到了黄色界面之后，根据下发数据又恢复到跳转白色界面"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="路由-path-动态修复">路由 Path 动态修复</h3>

<p>在实际开发中，开发人员因为马虎写错了路由 Path，上线之后无法进行正常的业务跳转，此时就需要通过远端下发路由进行匹配跳转了。scheme://router/demo3 是正确 path,但是本地写错的路由 path 为 scheme://router/demo33，那么需要新增一个 path 进行映射。</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">let</span> <span class="n">relocationMap</span> <span class="p">=</span> <span class="p">[</span><span class="s">"routerType"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">"className"</span><span class="p">:</span> <span class="s">"TheRouter_Example.TheRouterControllerC"</span><span class="p">,</span> <span class="s">"path"</span><span class="p">:</span> <span class="s">"scheme://router/demo33"</span><span class="p">]</span> <span class="k">as</span> <span class="nc">NSDictionary</span>
<span class="nc">TheRouterManager</span><span class="p">.</span><span class="nf">addRelocationHandle</span><span class="p">(</span><span class="n">routerMapList</span><span class="p">:</span> <span class="p">[</span><span class="n">relocationMap</span><span class="p">])</span>
<span class="n">let</span> <span class="n">value</span> <span class="p">=</span> <span class="nc">TheRouterCApi</span><span class="p">.</span><span class="nf">init</span><span class="p">().</span><span class="n">requiredURL</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="路由适配不同的-android-path">路由适配不同的 Android-Path</h3>

<p>在实际开发中，一旦使用 URI 这种方式，牵扯到双端，就可以存在双端不一致的问题，那么如何解决呢，可以通过本地新增多路由 path 解决，也可以通过远端下发新路由解决。</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kd">class</span> <span class="nc">TheRouterControllerB</span><span class="p">:</span> <span class="nc">TheRouterBController</span><span class="p">,</span> <span class="nc">TheRouterable</span> <span class="p">{</span>

    <span class="k">public</span> <span class="n">static</span> <span class="kd">var</span> <span class="py">patternString</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">]</span> <span class="p">{</span>
        <span class="p">[</span><span class="s">"scheme://router/demo2"</span><span class="p">,</span>
         <span class="s">"scheme://router/demo2Android"</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">static</span> <span class="n">func</span> <span class="nf">registerAction</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span> <span class="p">:</span> <span class="nc">Any</span><span class="p">])</span> <span class="p">-&gt;</span> <span class="nc">Any</span> <span class="p">{</span>
        <span class="n">let</span> <span class="n">vc</span> <span class="p">=</span>  <span class="nc">TheRouterBController</span><span class="p">()</span>
        <span class="n">vc</span><span class="p">.</span><span class="n">desLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">description</span>
        <span class="k">return</span> <span class="n">vc</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">let</span> <span class="n">relocationMap</span> <span class="p">=</span> <span class="p">[</span><span class="s">"routerType"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">"className"</span><span class="p">:</span> <span class="s">"TheRouter_Example.TheRouterControllerD"</span><span class="p">,</span> <span class="s">"path"</span><span class="p">:</span> <span class="s">"scheme://router/demo5"</span><span class="p">]</span> <span class="k">as</span> <span class="nc">NSDictionary</span>
<span class="nc">TheRouterManager</span><span class="p">.</span><span class="nf">addRelocationHandle</span><span class="p">(</span><span class="n">routerMapList</span><span class="p">:</span> <span class="p">[</span><span class="n">relocationMap</span><span class="p">])</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">(</span><span class="s">"scheme://router/demo2Android?desc=demo5是Android一个界面的path,为了双端统一，我们动态增加一个path,这样远端下发时demo5也就能跳转了"</span><span class="p">)</span>

</code></pre></div></div>

<h2 id="服务的动态注册与调用">服务的动态注册与调用</h2>

<h3 id="如何声明服务及实现服务">如何声明服务及实现服务</h3>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@</span><span class="n">objc</span>
<span class="k">public</span> <span class="n">protocol</span> <span class="nc">AppConfigServiceProtocol</span><span class="p">:</span> <span class="nc">TheRouterServiceProtocol</span> <span class="p">{</span>
    <span class="c1">// 打开小程序</span>
    <span class="n">func</span> <span class="nf">openMiniProgram</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">:</span> <span class="nc">Any</span><span class="p">])</span>
<span class="p">}</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">ConfigModuleService</span><span class="p">:</span> <span class="nc">NSObject</span><span class="p">,</span> <span class="nc">AppConfigServiceProtocol</span> <span class="p">{</span>
    
    <span class="n">static</span> <span class="kd">var</span> <span class="py">seriverName</span><span class="p">:</span> <span class="nc">String</span> <span class="p">{</span>
        <span class="nc">String</span><span class="p">(</span><span class="n">describing</span><span class="p">:</span> <span class="nc">AppConfigServiceProtocol</span><span class="p">.</span><span class="n">self</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="n">func</span> <span class="nf">openMiniProgram</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span> <span class="p">:</span> <span class="nc">Any</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">let</span> <span class="n">window</span> <span class="p">=</span> <span class="nc">UIApplication</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">delegate</span><span class="o">?.</span><span class="nf">window</span> <span class="p">{</span>
            <span class="n">window</span><span class="o">?.</span><span class="nf">makeToast</span><span class="p">(</span><span class="s">"打开微信小程序"</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="n">window</span><span class="o">?.</span><span class="n">center</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


</code></pre></div></div>
<h3 id="如何使用服务">如何使用服务</h3>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// 使用方式</span>
 <span class="k">if</span> <span class="n">let</span> <span class="n">appConfigService</span> <span class="p">=</span> <span class="nc">TheRouter</span><span class="p">.</span><span class="nf">fetchService</span><span class="p">(</span><span class="nc">AppConfigServiceProtocol</span><span class="p">.</span><span class="n">self</span><span class="p">){</span>
     <span class="n">appConfigService</span><span class="p">.</span><span class="nf">openMiniProgram</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="p">[:])</span>
<span class="p">}</span>
</code></pre></div></div>

<p>服务使用了runtime动态注册，所以你不用担心服务没有注册的问题。只需像上述案例一样使用即可。</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kd">class</span> <span class="err">func register</span><span class="nc">Services</span><span class="p">()</span> <span class="p">{</span>
    
    <span class="n">let</span> <span class="n">expectedClassCount</span> <span class="p">=</span> <span class="nf">objc_getClassList</span><span class="p">(</span><span class="n">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">allClasses</span> <span class="p">=</span> <span class="nc">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="nc">AnyClass</span><span class="p">&gt;.</span><span class="nf">allocate</span><span class="p">(</span><span class="n">capacity</span><span class="p">:</span> <span class="nc">Int</span><span class="p">(</span><span class="n">expectedClassCount</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">autoreleasingAllClasses</span> <span class="p">=</span> <span class="nc">AutoreleasingUnsafeMutablePointer</span><span class="p">&lt;</span><span class="nc">AnyClass</span><span class="p">&gt;(</span><span class="n">allClasses</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">actualClassCount</span><span class="p">:</span> <span class="nc">Int32</span> <span class="p">=</span> <span class="nf">objc_getClassList</span><span class="p">(</span><span class="n">autoreleasingAllClasses</span><span class="p">,</span> <span class="n">expectedClassCount</span><span class="p">)</span>
    <span class="kd">var</span> <span class="py">resultXLClass</span> <span class="p">=</span> <span class="p">[</span><span class="nc">AnyClass</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span> <span class="o">..</span><span class="p">&lt;</span> <span class="nf">actualClassCount</span> <span class="p">{</span>
        
        <span class="n">let</span> <span class="n">currentClass</span><span class="p">:</span> <span class="nc">AnyClass</span> <span class="p">=</span> <span class="n">allClasses</span><span class="p">[</span><span class="nc">Int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nf">class_getInstanceMethod</span><span class="p">(</span><span class="n">currentClass</span><span class="p">,</span> <span class="nc">NSSelectorFromString</span><span class="p">(</span><span class="s">"methodSignatureForSelector:"</span><span class="p">))</span> <span class="p">!=</span> <span class="n">nil</span><span class="p">),</span>
           <span class="p">(</span><span class="nf">class_getInstanceMethod</span><span class="p">(</span><span class="n">currentClass</span><span class="p">,</span> <span class="nc">NSSelectorFromString</span><span class="p">(</span><span class="s">"doesNotRecognizeSelector:"</span><span class="p">))</span> <span class="p">!=</span> <span class="n">nil</span><span class="p">),</span>
           <span class="n">let</span> <span class="n">cls</span> <span class="p">=</span> <span class="n">currentClass</span> <span class="k">as</span><span class="p">?</span> <span class="nc">TheRouterServiceProtocol</span><span class="p">.</span><span class="nc">Type</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">currentClass</span><span class="p">)</span>
            <span class="n">resultXLClass</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
            
            <span class="nc">TheRouterServiceManager</span><span class="p">.</span><span class="n">default</span><span class="p">.</span><span class="nf">registerService</span><span class="p">(</span><span class="n">named</span><span class="p">:</span> <span class="n">cls</span><span class="p">.</span><span class="n">seriverName</span><span class="p">,</span> <span class="n">lazyCreator</span><span class="p">:</span> <span class="p">(</span><span class="n">cls</span> <span class="k">as</span><span class="p">!</span> <span class="nc">NSObject</span><span class="p">.</span><span class="nc">Type</span><span class="p">).</span><span class="nf">init</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="路由远端调用本地服务服务接口下发mqttjsbridge">路由远端调用本地服务：服务接口下发，MQTT,JSBridge</h3>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">let</span> <span class="n">dict</span> <span class="p">=</span> <span class="p">[</span><span class="s">"ivar1"</span><span class="p">:</span> <span class="p">[</span><span class="s">"key"</span><span class="p">:</span><span class="s">"value"</span><span class="p">]]</span>
<span class="n">let</span> <span class="n">url</span> <span class="p">=</span> <span class="s">"scheme://services?protocol=AppConfigLAServiceProtocol&amp;method=openMiniProgramWithInfo:&amp;resultType=0"</span>
<span class="nc">TheRouter</span><span class="p">.</span><span class="nf">openURL</span><span class="p">((</span><span class="n">url</span><span class="p">,</span> <span class="n">dict</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="是否考虑swift59-macros">是否考虑Swift5.9 Macros？</h2>

<p>从目前的实现方式来看，懒加载加上动态注册，已经解决了注册时的性能问题。即使需要遍历全工程的类，然后处理相关逻辑，也不会超过0.2s。之所以能够通过Class取得path，因为给类声明了静态变量。</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// 实现TheRouterable协议</span>
<span class="n">extension</span> <span class="nc">TheRouterController</span><span class="p">:</span> <span class="nc">TheRouterable</span> <span class="p">{</span>
    
    <span class="n">static</span> <span class="kd">var</span> <span class="py">patternString</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span><span class="p">]</span> <span class="p">{</span>
<span class="na">        ["scheme://router/demo"]</span>
    <span class="p">}</span>
    
    <span class="n">static</span> <span class="n">func</span> <span class="nf">registerAction</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="p">[</span><span class="nc">String</span> <span class="p">:</span> <span class="nc">Any</span><span class="p">])</span> <span class="p">-&gt;</span> <span class="nc">Any</span> <span class="p">{</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        
        <span class="n">let</span> <span class="n">vc</span> <span class="p">=</span>  <span class="nc">TheRouterController</span><span class="p">()</span>
        <span class="n">vc</span><span class="p">.</span><span class="n">qrResultCallBack</span> <span class="p">=</span> <span class="n">info</span><span class="p">[</span><span class="s">"clouse"</span><span class="p">]</span> <span class="k">as</span><span class="p">?</span> <span class="nc">QrScanResultCallBack</span>
        <span class="n">vc</span><span class="p">.</span><span class="n">resultLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">description</span>
        <span class="k">return</span> <span class="n">vc</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="关于作者">关于作者</h2>

<p><a href="https://juejin.cn/user/1768489241815070">货拉拉移动端技术团队</a></p>

<h2 id="开源协议">开源协议</h2>

<p>TheRouter 采用Apache2.0协议，详情参考<a href="LICENSE">LICENSE</a></p>

<h2 id="交流沟通群">交流沟通群</h2>
<p><img src="https://cdn.kymjs.com:8843/therouter_assets/qiniu/image/wx_ios_group.jpg" class="blog-img" /></p>


	</div>
  
  
  
    
    

    
      <h3>相关推荐：</h3>
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
    
    
    <div class="col">
      <div class="card shadow-sm">
        <a href=/docs/2025/09/01/01>
          <svg class="bd-placeholder-img card-img-top" width="100%" height="125" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Thumbnail" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Compose 使用介绍</title><rect width="100%" height="100%" fill="#55595c"></rect><text x="5%" y="50%" fill="#eceeef" dy=".3em">Compose 使用介绍</text></svg>
        </a>

        <div class="card-body">
          <p class="card-text">
            
              现在也能支持 Compose 啦。从 1.3.1-rc1 版本开始，TheRouter 也支持 Jetpack Compose 了。    需要引入 compose 依赖：
            
          </p>
          <div class="d-flex justify-content-between align-items-center">
            <div class="btn-group">
              <a href=/docs/2025/09/01/01>
                <button type="button" class="btn btn-sm btn-outline-secondary">阅读</button>
              </a>
            </div>
            <small class="text-muted">3 mins</small>
          </div>
        </div>
      </div>
    </div>
    
    
  
    
    

    
    
    <div class="col">
      <div class="card shadow-sm">
        <a href=/docs/2025/05/14/01>
          <svg class="bd-placeholder-img card-img-top" width="100%" height="125" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Thumbnail" preserveAspectRatio="xMidYMid slice" focusable="false"><title>鸿蒙路由源码调试步骤</title><rect width="100%" height="100%" fill="#55595c"></rect><text x="5%" y="50%" fill="#eceeef" dy=".3em">鸿蒙路由源码调试步骤</text></svg>
        </a>

        <div class="card-body">
          <p class="card-text">
            
              本文已迁移至：https://kymjs.com/code/2025/03/23/01/


            
          </p>
          <div class="d-flex justify-content-between align-items-center">
            <div class="btn-group">
              <a href=/docs/2025/05/14/01>
                <button type="button" class="btn btn-sm btn-outline-secondary">阅读</button>
              </a>
            </div>
            <small class="text-muted">1 mins</small>
          </div>
        </div>
      </div>
    </div>
    
    
  
    
  
    
    

    
    
    <div class="col">
      <div class="card shadow-sm">
        <a href=/docs/2025/03/23/01>
          <svg class="bd-placeholder-img card-img-top" width="100%" height="125" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Thumbnail" preserveAspectRatio="xMidYMid slice" focusable="false"><title>从零接入鸿蒙路由 TheRouter</title><rect width="100%" height="100%" fill="#55595c"></rect><text x="5%" y="50%" fill="#eceeef" dy=".3em">从零接入鸿蒙路由 TheRouter</text></svg>
        </a>

        <div class="card-body">
          <p class="card-text">
            
              `TheRouter` 是货拉拉基于HMRouter深度定制的开源路由框架，提供了 Android、iOS、Harmony 三端高一致性使用，在支持平台化...
            
          </p>
          <div class="d-flex justify-content-between align-items-center">
            <div class="btn-group">
              <a href=/docs/2025/03/23/01>
                <button type="button" class="btn btn-sm btn-outline-secondary">阅读</button>
              </a>
            </div>
            <small class="text-muted">4 mins</small>
          </div>
        </div>
      </div>
    </div>
    
    
  
    
    

    
      
  
    </div>
  

</div>
<!--End Main Container -->

  </body>

  <!-- Footer -->
<footer> 
  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <h3><i class="bi bi-link-45deg bi-footer"></i> 友情链接</h3>
        <p><a href="https://www.huolala.cn/"> 货拉拉</a></p>
        <p><a href="https://www.huolala.cn/house_move.html"> 无忧搬家</a></p>
        <p><a href="https://www.xiaolachuxing.com/"> 小拉出行</a></p>
      </div>
      <div class="col-md-4">
        <h3><i class="bi bi-slack bi-footer"></i> 社区</h3>
        <p><a href="https://therouter.cn/docs/2022/08/24/01"> 官方微信群 </a></p>
        <p><a href="https://kymjs.com"> 开源实验室</a></p>
        <p><a href="https://1-0.top"> 零一开源 </a></p>
      </div>
      <div class="col-md-4">
        <h3><i class="bi bi-postcard-heart bi-footer"></i> 关于</h3>
        <p><a href="https://juejin.cn/user/1768489241815070/posts"> 货拉拉移动技术团队</a></p>
        <p><a href="https://github.com/HuolalaTech"> GitHub </a></p>
      </div>    
    </div>
  </div>

  <div class="copyright text center">
    <p>&copy; Copyright 2026, <a href="#">TheRouter</a>. <br>Theme ported by <a href="https://melvinchng.github.io/" target="_blank">Melvin Ch'ng</a></p>
  </div>
</footer>
</html>
